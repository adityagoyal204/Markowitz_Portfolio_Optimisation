# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/125H44QTv3APdprXPAYfa-CWkZuxBC4VG
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
plt.style.use('bmh')

from google.colab import drive
drive.mount('/content/gdrive')

"""This dataset contains Historical information about adjusted closing prices of wight different stocks from National Stock Exchange of India. \\
Following stocks are taken into consideration - \\

*   Reliance
*   Tata Consultancy Services
*   Bajaj Finance
*   Bharti Airtel
*   Tata Steel
*   HDFC
*   Cipla Pharmaceuticals
*   Havells



"""

path = '/content/gdrive/MyDrive/STOCKS.csv'
df=pd.read_csv(path)

df.head()

stck = pd.read_csv(path)
stck.drop('Date',axis=1,inplace=True)

df['Date']= pd.to_datetime(df['Date'])
df.set_index('Date',inplace = True)

"""Plotting the variation of Stock Prices vs Number of days since 01-01-2016"""

plt.figure(figsize=(20,20))
for c in stck.columns.values:
  plt.plot( stck[c],  label=c)

plt.xlabel('Date',fontsize=18)
plt.ylabel('Adj. Price',fontsize=18)
plt.legend(stck.columns.values, loc=2)
plt.show()

stocks =  [ "RELIANCE","TCS","BAJAJ","BHARTIARTL","TATASTEEL","HDFC","CIPLA","HAVELLS"]

"""Following formulae were applied in the next code cell 
<br><br>

>![CodeCogsEqn.gif](data:image/gif;base64,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)





<br>

>![CodeCogsEqn (1).gif](data:image/gif;base64,R0lGODlh5wAnALMAAP///wAAAO7u7oiIiFRUVHZ2dtzc3JiYmCIiIrq6ujIyMkRERKqqqmZmZszMzBAQECH5BAEAAAAALAAAAADnACcAAAT+EMhJq7046827foGyjOSigEGAWMLgva+LtXCtyXau73zFBIWMgIEIOCqE3kuwEFAEDUxS2WE6JVCqdssFNAKJzSA6GYS7mIaBPGEcLGZ0ek1xy+/4DeJxzQQnCnkUMgJvFIEViIIAhIYSiouRcgYhG312kn4MdY6ZFQWbnqJUP38cCwajFglTEqiqFKywszkEYB0PqwxqCQcNfTsJuwa9vxS5E8gTDrttbDvMbM3JtNUwe8AYKxTMAA4Lbwhn0Jvf4eMAARTbWJsPRwALODpDAO+u8+rW+xsOAQsbDEBiJMGfk046ZBgEgJCPBIGxvOmzBy+YxGQV7WXjx3FCAYD+GhwMLNNqVYmT4DIMKLnuikgLBab4u5AAZQmEEmIWnCgBwcaO/CBaYpcoFBcFRisoE0C055kBIJWIkwBVKdCrrlJxUCYhDKUr83R4DQDWKrUnZPFREZA2Xliugmh0CSuHADoNCvocWLH3oNYdexn6ZPgXgIGoAPJW0EcpIw/GRigcnrGywAAXBujCYKklC54COCsYAGvUAChioBznMM0ANQPHBzoNSMoQdAGePQ7Yxh37wl50BaYmvLsFE5ppGloZ4DyqiWTmjJ5pGVPB+afBsXDXGHl0EuILTEzF+5lpuQXric88KMxDgfrC5iscCMD+0Q7jckB1EaAYfILb9En+Jp0oxojGxhQNhKYDgggVOAFbmgEgXg2v4CELFwukoOGGHDYFgDCwHKBaV6HENhsXJtImIkxtbcDAALrBEw0W60kA14fDFEOeN8ghZ2NH9UkS5ARDChIkAt+lIYMBudRzT3o9VdCNOQAIx4I78MizWBoEdOnllxNiJaYSQHBwACRGhDETVakIVcZOB2Wg5kRPJrPjmHgKEoCCRj3gCFvw6CSBIS9dsJIHgq7Z0hYcNuroo5BGKumklFZq6aUcVhkmYQ8FOOhEVhrCFAZIeSBcVWblqWomA4xkgFGKJoZDWw78BddYZQnRlpapVtDAl8ASsOmqxG6ggHi9VIAAPAfvlNRWJ/0JJphfDxGwEWSOTVbstnmMYdkA9bHWWx2gIHTiQ6f999oyflqgm27ajcvtvKrG5wFtgwyIHr0eFfEXFP8Qx68g+7qYyHuiQUfvAA9Ip3AOCSgw4sAC3msBgxY4SPGgBXBViBaZ+TPxxiR2gG+K7o48rwO1BmBUAkXqEBnJGcSsg83cGiLCm13MTPPPosjwQ65c+Az00YvMKoOCj6mM9NNKEDNBA7nAjIbRUGetRSf+JItBTTaNwHQ6TmttdgzKEhBhD1if7XYNYQ2wpxxtv233Bl4/WDeZAt/tt68PIEDbgD0IEFMIBZQtRwQAOw==)

<br>
Resampling of data is important because we need to find annual return. Hence, taking the last of the values of yearly sampled data


"""

returns = df.pct_change()
cov_matrix = returns.cov()
meanReturns = df.resample('Y').last().pct_change().mean()

"""

> ![CodeCogsEqn (2).gif](data:image/gif;base64,R0lGODlh1wAUALMAAP///wAAAHZ2diIiImZmZkRERO7u7lRUVDIyMpiYmKqqqszMzNzc3IiIiBAQELq6uiH5BAEAAAAALAAAAADXABQAAAT+EMhJq7046827/2AojhYiJEWRNAPpvnAsz7T4PJIqCXXv/8AgLDFxMCSKj2AQIAgIBYFB+GskklSMFatZErIjhoNUOFAICI5hCuasFK3g+vKObxDch72dQZECRBMKAQsbBQ18GwMLDDhBhxeLjR0BbACTiRkHiCILAUcTDZUbhJkYDAFgpRWoH3qmHosjDWMTBg6BGQu1sBUKaVS7F79KX70aBqkjZRIGCgWOgleIDwIIJkQLCsYA2xLVDwwnjgpWBgkJB4UY5QkC681LJtEU5Q0M6NzdVu/fAuHjql07YUveP1/84CEIpE3fPnfwYDScQCDJrSPpcFma8GBbowT+BDY2UQCywEYAm7450gHAGQAH61J2YzCAhwAzjXYFeoaBACcxFlhacJYsEAGjP2spoGnTDAChFKBK8CkBqIRPLZPApJj0AoEDYMOK5VHBpayX6xDQu6ANwAIdA6J5AgWgATAJCewIAIUVAA5PRQopMPDAwZRw3QDkDeW0QoK7AFYFxoCj8ISbiiETGlz4MF+6FLZSeEyhlGW/l5RlLh2RBI5WqUOBvsDJ05RcdXkpVg1gQAGSDRydvuwU9pQnXsmi5FQBly3JLXnTbnzgi/NmhI47HE4hmYXr0QthvswNfLLWLsb7wfuhQeOo7wnwSjYbwPgJcfEWoIDngoNofVH+gApdCUj3iga/FbFUgAVO0B8F91Fw4AQDTtAgAAuFtk6FeEn3Qn7LWfjBgxUAQsEAwKzhIYZEuBQZGylZNAorqhGzFmAOMieBe6Sw8QqOEiDASTInZejiju+5xZuQVzHAgGAt/LWkjhSJZeUBypXIBohPcvDajMw9AB0C+01yVjeFyMKcMreEgwMxFpA2FQ+4SXBWOhbIhIFtQa5zZ2NwnlgIlXritw6e0Sm2A512HpokDEa05AAWddLRQl63gfIEARVNsMAB6FQlgAIksVHOUhZW1BFBdVG5Yy4LjHrSJaOG+h16FDRwVDl0iUMSbg24eupsoglYK27jSBDrYKJM/trDA0cl8OkKs1rgayOj4npMDN4hWOkM3W4r7rguPODMoyXWF4O5CqBL7rvwXhAAtNoqu2IM8xJQb7z8vovOtxwhEECWM/zbLx8RAAA7)
<br>


> ![CodeCogsEqn (3).gif](data:image/gif;base64,R0lGODlhtQAWALMAAP///wAAAIiIiCIiIlRUVMzMzJiYmHZ2dhAQEO7u7rq6utzc3KqqqmZmZkRERDIyMiH5BAEAAAAALAAAAAC1ABYAAAT+EMhJq7046827/0UgjsFnnmiqrmwrEYn6HIbjGMLg7nzvq4uGSqGQ3CSHn3LJ9BEWlITAY5ggoAAGb0rJBQiFbmBQ3RwGQtY53fQtCBX4aYFQJtjIukXeeWg3CTETCjoTfhWEUYJtHg1hEwJFJzVLDGUSBiUVBoscAZ0YDlwSC5ISnxWlFKKMHgkOFQ8pBKM/soMBWKR/HYmejxe+GgHArRoHxZYpA8U+B7wLAaYASR8HeBgFehjXG9rGHK8VDrofCZpLCnwAAZcM5RQMAgbIhpcAAgIMBVAKBw8zqhRggOfBvYFp/AGkAQDhBILgDkwDsE2CQwkNtCS4AsAAAQT+nC4YGEBCz0UAGQFsLFcRQRopGBpwoTMh14QjAAjcAoAzgRYEwGxK8EkRWM+fj1hZaECgqdOn1U7AqlBoqBZmEoBKeDDxAoEGCRYoVXn1kVYAXCmg4zm1FgUDO9mFUbCN0ouoQotEG1RR79q8DdGd5VFgHSRepOL6JYVOADwLdgEo2LkYwF4JjikgWNRAR4GuWS+dC3OAD0grkuhW6IbEMDU2qimUtrjWBUGhFOJa1E1NTuR7GAYzmDphdkfiwAcsElDC7YRoujJtLQOddnHDgw1aGGx8wgBJAojviOFyE3CVVb1LojXhfKqKDaJK+P5iFPCKDAIcADUhRG4uuSz+UIB/mMFShHZEMaCDJAECo6Bk05GlEio8OYfRUxgSIJ8FzHXCW1YWUEifZc1YMJlmoIgoiYAVVBSCe9494tFQJZShRwIzdAQAVlwckEQV5+hY3I/zhTGKJtGU6MI59sH4ACgcbfQHjC1OQABiWUEhJSapiIfjBgs8Y8A9NKSW0T4NhCTPOxY9I0iZFBTgpgRrRkfDAbX10JkhGeiDSJoGFIYDfxcUoI8ASioAqKACgDImOMYIgE0PIRQhTwZvQOqBA4Rq6kJaFD3WwwOwiHcBp55qkGmqP8iRZhv5CbChBUGwGlOntqowpp+MIEChBgpgaWuguRbLgqweiJpqOREBAAA7)

>![CodeCogsEqn (4).gif](data:image/gif;base64,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)


"""

def portfolio_annualised_performance(weights, mean_returns, cov_matrix):
    returns = np.sum(mean_returns*weights )
    std = np.sqrt(np.dot(weights.T, np.dot(cov_matrix, weights))) * np.sqrt(252)
    return std, returns

def random_portfolios(num_portfolios, mean_returns, cov_matrix, risk_free_rate):
    results = np.zeros((3,num_portfolios))
    weights_record = []
    for i in range(num_portfolios):
        weights = np.random.random(8)
        weights = weights/np.sum(weights)
        weights_record.append(weights)
        portfolio_std_dev, portfolio_return = portfolio_annualised_performance(weights, mean_returns, cov_matrix)
        results[0,i] = portfolio_std_dev
        results[1,i] = portfolio_return
        results[2,i] = (portfolio_return - risk_free_rate) / portfolio_std_dev
    return results, weights_record
        

def display_simulated_ef_with_random(mean_returns, cov_matrix, num_portfolios, risk_free_rate):
    results, weights = random_portfolios(num_portfolios,mean_returns, cov_matrix, risk_free_rate)
    max_sharpe_idx = np.argmax(results[2])
    sdp, rp = results[0,max_sharpe_idx], results[1,max_sharpe_idx]
    optimised_weights = weights[max_sharpe_idx]
    return sdp,rp,optimised_weights,results

pip install PyPortfolioOpt

sdp,rp,optimised_weights,results = display_simulated_ef_with_random(meanReturns, cov_matrix, 10000, 0)

"""# Plot of efficient Frontier"""

plt.figure(figsize=(12,12))
plt.scatter(results[0],results[1],c = results[2])
plt.colorbar()
plt.scatter(sdp,rp,c='red')
plt.show()

"""Using PyPortfolioOpt library to determine an investment portfolio for INR 10000 from above used assets"""

wtLST = optimised_weights.tolist()
wht = dict(zip(stocks,wtLST))
from pypfopt.discrete_allocation import DiscreteAllocation, get_latest_prices
latest_prices = get_latest_prices(df)
weights = wht
da = DiscreteAllocation(weights, latest_prices, total_portfolio_value=10000)
allocation, leftover = da.lp_portfolio()
ALLOC = pd.Series(allocation,index=stocks)
print(ALLOC)
print("Funds remaining: Rs. {:.2f}".format(leftover))